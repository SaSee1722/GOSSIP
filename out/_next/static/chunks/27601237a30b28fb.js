(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,32758,78178,e=>{"use strict";var t=e.i(49982),a=e.i(77600),r=e.i(72013),s=e.i(66635),i=e.i(23995);let n={async getStatuses(){try{return await (0,i.safeSupabaseOperation)(async e=>{let t=new Date(Date.now()-864e5).toISOString(),{data:a,error:r}=await e.from("statuses").select(`
            *,
            profiles (
              id,
              username,
              full_name,
              avatar_url
            )
          `).gt("created_at",t).order("created_at",{ascending:!1});return r?{data:[],error:r.message}:{data:a||[],error:null}})}catch(e){return{data:[],error:e.message}}},async uploadStatus(e,t){try{return await (0,i.safeSupabaseOperation)(async a=>{let{data:{user:r}}=await a.auth.getUser();if(!r)throw Error("Not authenticated");let{error:s}=await a.from("statuses").insert({user_id:r.id,media_url:e,caption:t});return s?{error:s.message}:{error:null}})}catch(e){return{error:e.message}}},uploadMedia:async e=>await (0,i.safeSupabaseOperation)(async t=>{try{let{data:{user:a}}=await t.auth.getUser();if(!a)throw Error("Not authenticated");console.log("[StatusService] Starting upload for file:",e.name);let r=e.name.split(".").pop(),s=`${a.id}_${Date.now()}.${r}`,i=`${s}`,{error:n}=await t.storage.from("status-uploads").upload(i,e,{contentType:e.type,upsert:!1});if(n)throw console.error("[StatusService] Upload error:",n),n;let{data:o}=t.storage.from("status-uploads").getPublicUrl(i);return console.log("[StatusService] Upload successful, URL:",o.publicUrl),{data:o.publicUrl,error:null}}catch(e){return console.error("[StatusService] Upload failed:",e),{data:null,error:e.message}}})};e.s(["StatusService",0,n],78178);let o=(0,r.createContext)(void 0);function l(e){let l,c,u,m,h,f,p,g=(0,a.c)(13),{children:w}=e;g[0]===Symbol.for("react.memo_cache_sentinel")?(l=[],g[0]=l):l=g[0];let[_,y]=(0,r.useState)(l),[v,b]=(0,r.useState)(!0),{user:S}=(0,s.useAuth)();g[1]===Symbol.for("react.memo_cache_sentinel")?(c=(0,i.createClient)(),g[1]=c):c=g[1];let x=c;g[2]===Symbol.for("react.memo_cache_sentinel")?(u=async()=>{b(!0);let{data:e}=await n.getStatuses();e&&y(e),b(!1)},g[2]=u):u=g[2];let C=u;g[3]!==S?(m=()=>{if(S){C();let e=x.channel("public-statuses").on("postgres_changes",{event:"*",schema:"public",table:"statuses"},()=>{C()}).subscribe();return()=>{x.removeChannel(e)}}},g[3]=S,g[4]=m):m=g[4];let k=S?.id;return g[5]!==k?(h=[k],g[5]=k,g[6]=h):h=g[6],(0,r.useEffect)(m,h),g[7]!==v||g[8]!==_?(f={statuses:_,loading:v,uploadStatus:d,refreshStatuses:C},g[7]=v,g[8]=_,g[9]=f):f=g[9],g[10]!==w||g[11]!==f?(p=(0,t.jsx)(o.Provider,{value:f,children:w}),g[10]=w,g[11]=f,g[12]=p):p=g[12],p}async function d(e,t){let{error:a}=await n.uploadStatus(e,t);if(a)throw Error(a)}function c(){let e=(0,r.useContext)(o);if(!e)throw Error("useStatus must be used within StatusProvider");return e}e.s(["StatusProvider",()=>l,"useStatus",()=>c],32758)},89153,(e,t,a)=>{"use strict";var r=e.r(72013).__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;a.c=function(e){return r.H.useMemoCache(e)}},77600,(e,t,a)=>{"use strict";t.exports=e.r(89153)},7711,e=>{"use strict";var t=e.i(72013);let a=e=>{let t=e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,a)=>a?a.toUpperCase():t.toLowerCase());return t.charAt(0).toUpperCase()+t.slice(1)},r=(...e)=>e.filter((e,t,a)=>!!e&&""!==e.trim()&&a.indexOf(e)===t).join(" ").trim();var s={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let i=(0,t.forwardRef)(({color:e="currentColor",size:a=24,strokeWidth:i=2,absoluteStrokeWidth:n,className:o="",children:l,iconNode:d,...c},u)=>(0,t.createElement)("svg",{ref:u,...s,width:a,height:a,stroke:e,strokeWidth:n?24*Number(i)/Number(a):i,className:r("lucide",o),...!l&&!(e=>{for(let t in e)if(t.startsWith("aria-")||"role"===t||"title"===t)return!0})(c)&&{"aria-hidden":"true"},...c},[...d.map(([e,a])=>(0,t.createElement)(e,a)),...Array.isArray(l)?l:[l]])),n=(e,s)=>{let n=(0,t.forwardRef)(({className:n,...o},l)=>(0,t.createElement)(i,{ref:l,iconNode:s,className:r(`lucide-${a(e).replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}`,`lucide-${e}`,n),...o}));return n.displayName=a(e),n};e.s(["default",()=>n],7711)},66635,e=>{"use strict";var t=e.i(49982),a=e.i(77600),r=e.i(72013),s=e.i(23995);let i=(0,r.createContext)(void 0);function n(e){let n,o,l,d,c,u,m,h,f,p=(0,a.c)(14),{children:g}=e,[w,_]=(0,r.useState)(null),[y,v]=(0,r.useState)(!0),[b,S]=(0,r.useState)(!1);p[0]===Symbol.for("react.memo_cache_sentinel")?(n=(0,s.createClient)(),p[0]=n):n=p[0];let x=n;p[1]===Symbol.for("react.memo_cache_sentinel")?(o=async e=>{let{data:t}=await x.from("profiles").select("*").eq("id",e.id).single();_(function(e,t){return{id:e.id,email:e.email||"",username:t?.username||e.user_metadata?.username||e.email?.split("@")[0],full_name:t?.full_name||e.user_metadata?.full_name,avatar_url:t?.avatar_url||e.user_metadata?.avatar_url,age:t?.age,phone:t?.phone,bio:t?.bio,gender:t?.gender,created_at:e.created_at,updated_at:e.updated_at||e.created_at}}(e,t))},p[1]=o):o=p[1];let C=o;p[2]===Symbol.for("react.memo_cache_sentinel")?(l=()=>{(async()=>{let{data:e}=await x.auth.getSession(),{session:t}=e;t?.user&&await C(t.user),v(!1);let{data:a}=x.auth.onAuthStateChange(async(e,t)=>{t?.user?await C(t.user):_(null),v(!1)}),{subscription:r}=a;return()=>r.unsubscribe()})()},d=[],p[2]=l,p[3]=d):(l=p[2],d=p[3]),(0,r.useEffect)(l,d),p[4]===Symbol.for("react.memo_cache_sentinel")?(c=async(e,t)=>{S(!0);let{error:a}=await x.auth.signInWithPassword({email:e,password:t});return S(!1),{error:a?.message}},p[4]=c):c=p[4];let k=c;p[5]===Symbol.for("react.memo_cache_sentinel")?(u=async(e,t,a)=>{S(!0);let{data:r,error:s}=await x.auth.signUp({email:e,password:t,options:{data:a}});return S(!1),{error:s?.message,needsEmailConfirmation:!!(r.user&&!r.session)}},p[5]=u):u=p[5];let j=u;p[6]===Symbol.for("react.memo_cache_sentinel")?(m=async()=>{await x.auth.signOut(),_(null)},p[6]=m):m=p[6];let N=m;return p[7]!==y||p[8]!==b||p[9]!==w?(h={user:w,loading:y,operationLoading:b,signInWithPassword:k,signUpWithPassword:j,logout:N},p[7]=y,p[8]=b,p[9]=w,p[10]=h):h=p[10],p[11]!==g||p[12]!==h?(f=(0,t.jsx)(i.Provider,{value:h,children:g}),p[11]=g,p[12]=h,p[13]=f):f=p[13],f}e.s(["AuthProvider",()=>n,"useAuth",0,()=>{let e=(0,r.useContext)(i);if(!e)throw Error("useAuth must be used within AuthProvider");return e}])},76845,e=>{"use strict";let t=(0,e.i(7711).default)("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]);e.s(["X",()=>t],76845)},18409,e=>{"use strict";var t=e.i(49982),a=e.i(77600),r=e.i(36835);function s(e){let s,i,n,o=(0,a.c)(8),{src:l,fallback:d,className:c}=e;return o[0]!==c?(s=(0,r.cn)("relative w-10 h-10 rounded-full overflow-hidden bg-muted flex items-center justify-center",c),o[0]=c,o[1]=s):s=o[1],o[2]!==d||o[3]!==l?(i=l?(0,t.jsx)("img",{src:l,alt:d,className:"w-full h-full object-cover"}):(0,t.jsx)("span",{className:"font-medium text-muted-foreground uppercase",children:d.slice(0,2)}),o[2]=d,o[3]=l,o[4]=i):i=o[4],o[5]!==s||o[6]!==i?(n=(0,t.jsx)("div",{className:s,children:i}),o[5]=s,o[6]=i,o[7]=n):n=o[7],n}e.s(["Avatar",()=>s])},35907,31151,e=>{"use strict";var t=e.i(7711);let a=(0,t.default)("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);e.s(["CheckCircle",()=>a],35907);let r=(0,t.default)("circle-alert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);e.s(["AlertCircle",()=>r],31151)},8674,e=>{"use strict";let t=(0,e.i(7711).default)("info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);e.s(["Info",()=>t],8674)},89934,e=>{"use strict";var t=e.i(49982),a=e.i(77600),r=e.i(72013),s=e.i(76845),i=e.i(35907),n=e.i(31151),o=e.i(8674);let l=(0,e.i(7711).default)("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);var d=e.i(36835);let c=(0,r.createContext)(void 0);function u(e){let u,m,h,f,p,g,w,_=(0,a.c)(14),{children:y}=e;_[0]===Symbol.for("react.memo_cache_sentinel")?(u=[],_[0]=u):u=_[0];let[v,b]=(0,r.useState)(u);_[1]===Symbol.for("react.memo_cache_sentinel")?(m=(e,t)=>{let a=void 0===t?"info":t,r=Math.random().toString(36).substring(2,9);b(t=>[...t,{id:r,message:e,type:a}]),setTimeout(()=>{b(e=>e.filter(e=>e.id!==r))},3e3)},_[1]=m):m=_[1];let S=m;_[2]===Symbol.for("react.memo_cache_sentinel")?(h=e=>{b(t=>t.filter(t=>t.id!==e))},_[2]=h):h=_[2];let x=h;if(_[3]!==v?(f={toasts:v,addToast:S,removeToast:x},_[3]=v,_[4]=f):f=_[4],_[5]!==v){let e;_[7]===Symbol.for("react.memo_cache_sentinel")?(e=e=>(0,t.jsxs)("div",{className:(0,d.cn)("pointer-events-auto min-w-[300px] max-w-sm p-4 rounded-xl shadow-lg border backdrop-blur-md flex items-start gap-3 animate-in slide-in-from-right-full fade-in duration-300","success"===e.type&&"bg-green-500/10 border-green-500/20 text-green-500","error"===e.type&&"bg-red-500/10 border-red-500/20 text-red-500","warning"===e.type&&"bg-yellow-500/10 border-yellow-500/20 text-yellow-500","info"===e.type&&"bg-blue-500/10 border-blue-500/20 text-blue-500"),children:["success"===e.type&&(0,t.jsx)(i.CheckCircle,{className:"w-5 h-5 shrink-0"}),"error"===e.type&&(0,t.jsx)(n.AlertCircle,{className:"w-5 h-5 shrink-0"}),"warning"===e.type&&(0,t.jsx)(l,{className:"w-5 h-5 shrink-0"}),"info"===e.type&&(0,t.jsx)(o.Info,{className:"w-5 h-5 shrink-0"}),(0,t.jsx)("div",{className:"flex-1 text-sm font-medium",children:e.message}),(0,t.jsx)("button",{onClick:()=>x(e.id),className:"opacity-70 hover:opacity-100",children:(0,t.jsx)(s.X,{className:"w-4 h-4"})})]},e.id),_[7]=e):e=_[7],p=v.map(e),_[5]=v,_[6]=p}else p=_[6];return _[8]!==p?(g=(0,t.jsx)("div",{className:"fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none",children:p}),_[8]=p,_[9]=g):g=_[9],_[10]!==y||_[11]!==f||_[12]!==g?(w=(0,t.jsxs)(c.Provider,{value:f,children:[y,g]}),_[10]=y,_[11]=f,_[12]=g,_[13]=w):w=_[13],w}function m(){let e=(0,r.useContext)(c);if(!e)throw Error("useToast must be used within a ToastProvider");return e}e.s(["ToastProvider",()=>u,"useToast",()=>m],89934)},58086,e=>{"use strict";var t=e.i(23995);let a=async(e,t,a,r)=>(console.log("[NotificationService] Web Push Stub:",{token:e,title:t,body:a,data:r}),!0);e.s(["ChatService",0,{async getMyRooms(){try{return await (0,t.safeSupabaseOperation)(async e=>{let{data:{user:t}}=await e.auth.getUser();if(!t)throw Error("Not authenticated");console.log("[ChatService] Fetching rooms for user:",t.id);let{data:a,error:r}=await e.from("room_participants").select("room_id").eq("user_id",t.id);if(r)return console.error("[ChatService] Error fetching participations:",r),{data:[],error:r.message};if(!a||0===a.length)return console.log("[ChatService] No participations found."),{data:[],error:null};let s=a.map(e=>e.room_id),{data:i,error:n}=await e.from("rooms").select(`
                        *,
                        participants:room_participants(
                            user_id,
                            profiles(username, full_name, avatar_url, gender, is_online, last_seen)
                        )
                    `).in("id",s).order("created_at",{ascending:!1});if(n)return console.error("[ChatService] Error fetching rooms:",n),{data:[],error:n.message};let{data:o}=await e.from("blocked_users").select("blocked_id").eq("blocker_id",t.id),l=new Set((o||[]).map(e=>e.blocked_id)),d=new Set,c=i.map(e=>({...e,room_participants:e.participants})).filter(e=>{if("direct"===e.type){let a=e.participants.find(e=>e.user_id!==t.id);if(a&&l.has(a.user_id))return!1;if(a){if(d.has(a.user_id))return!1;d.add(a.user_id)}}return!0});return console.log("[ChatService] Returning rooms:",c.length),{data:c,error:null}})}catch(e){return console.error("[ChatService] getMyRooms exception:",e),{data:[],error:e.message}}},async getRoomParticipants(e){try{return await (0,t.safeSupabaseOperation)(async t=>{let{data:a,error:r}=await t.from("room_participants").select(`
            user_id,
            profiles (
              id,
              username,
              full_name,
              avatar_url,
              is_online,
              last_seen,
              gender,
              age
            )
          `).eq("room_id",e);return r?{data:[],error:r.message}:{data:a.map(e=>e.profiles),error:null}})}catch(e){return{data:[],error:e.message}}},async getMessages(e,a=50,r=!0){try{return await (0,t.safeSupabaseOperation)(async t=>{let{data:s,error:i}=await t.from("messages").select(`
                        *,
                        profiles:user_id (
                            id, username, full_name, avatar_url, gender
                        )
                    `).eq("room_id",e).order("created_at",{ascending:r}).limit(a);return i?{data:[],error:i.message}:{data:s||[],error:null}})}catch(e){return{data:[],error:e.message}}},async sendMessage(e,r,s="text",i){try{return await (0,t.safeSupabaseOperation)(async t=>{let{data:{user:n}}=await t.auth.getUser();if(!n)throw Error("Not authenticated");let{data:o}=await t.from("room_participants").select("user_id").eq("room_id",e).neq("user_id",n.id);if(o&&o.length>0){let e=o.map(e=>e.user_id),{data:a}=await t.from("blocked_users").select("id").or(`and(blocker_id.eq.${n.id},blocked_id.in.(${e.join(",")})),and(blocker_id.in.(${e.join(",")}),blocked_id.eq.${n.id})`).maybeSingle();if(a)throw Error("Cannot send message: Blocked connection")}let{data:l,error:d}=await t.from("messages").insert({room_id:e,user_id:n.id,content:r,message_type:s,media_url:i,status:"sent"}).select().single();return d?(console.error("[ChatService] sendMessage error:",d),{data:null,error:d.message}):((async()=>{try{let{data:i}=await t.from("room_participants").select("user_id, profiles(push_token, full_name, username)").eq("room_id",e).neq("user_id",n.id);if(i){let t=n.user_metadata?.username||"Gossiper",o=`New Gossip from ${t}`,l="text"===s?r:`Sent a ${s}`;for(let t of i){let r=t.profiles;r&&r.push_token&&a(r.push_token,o,l,{chatId:e,senderId:n.id})}}}catch(e){console.error("[ChatService] Failed to send push:",e)}})(),{data:l,error:null})})}catch(e){return{data:null,error:e.message}}},deleteMessage:async e=>await (0,t.safeSupabaseOperation)(async t=>{let{error:a}=await t.from("messages").update({is_deleted:!0,content:"deleted"}).eq("id",e);return{error:a?.message||null}}),async createDirectChat(e){try{return await (0,t.safeSupabaseOperation)(async t=>{let{data:{user:a}}=await t.auth.getUser();if(!a)throw Error("Not authenticated");let{data:r}=await t.rpc("get_direct_room",{user1:a.id,user2:e});if(r)return{data:r,error:null};let{data:s,error:i}=await t.from("rooms").insert({type:"direct",created_by:a.id}).select().single();if(i)return{data:null,error:i.message};let n=[{room_id:s.id,user_id:a.id,role:"owner"},{room_id:s.id,user_id:e,role:"member"}],{error:o}=await t.from("room_participants").insert(n);return o?{data:null,error:o.message}:{data:s.id,error:null}})}catch(e){return{data:null,error:e.message}}},async createGroupChat(e,a){try{return await (0,t.safeSupabaseOperation)(async t=>{let{data:{user:r}}=await t.auth.getUser();if(!r)throw Error("Not authenticated");let{data:s,error:i}=await t.from("rooms").insert({name:e,type:"group",created_by:r.id}).select().single();if(i)return{data:null,error:i.message};let n=[{room_id:s.id,user_id:r.id,role:"owner"},...a.map(e=>({room_id:s.id,user_id:e,role:"member"}))],{error:o}=await t.from("room_participants").insert(n);return o?{data:null,error:o.message}:{data:s.id,error:null}})}catch(e){return{data:null,error:e.message}}},updateRoom:async(e,a)=>await (0,t.safeSupabaseOperation)(async t=>{let{error:r}=await t.from("rooms").update(a).eq("id",e);return{error:r?.message||null}}),uploadGroupAvatar:async(e,a)=>await (0,t.safeSupabaseOperation)(async t=>{try{let r=a.name.split(".").pop()||"jpg",s=`group_${e}_${Date.now()}.${r}`,i=`groups/${s}`,{error:n}=await t.storage.from("gossip-avatars").upload(i,a,{contentType:a.type,upsert:!1});if(n)throw n;let{data:o}=t.storage.from("gossip-avatars").getPublicUrl(i);return{data:o.publicUrl,error:null}}catch(e){return{data:null,error:e.message}}}),uploadChatAttachment:async(e,a,r)=>await (0,t.safeSupabaseOperation)(async t=>{try{let s=a.name.split(".").pop()||"dat",i=`${"image"===r?"images":"video"===r?"videos":"docs"}/${e}_${Date.now()}.${s}`,{error:n}=await t.storage.from("chat-attachments").upload(i,a,{contentType:a.type,upsert:!1});if(n)throw n;let{data:o}=t.storage.from("chat-attachments").getPublicUrl(i);return{data:o.publicUrl,error:null}}catch(e){return{data:null,error:e.message}}}),updateOnlineStatus:async(e,a)=>await (0,t.safeSupabaseOperation)(async t=>{let{error:r}=await t.from("profiles").update({is_online:a,last_seen:new Date().toISOString()}).eq("id",e);return{error:r?.message||null}}),getRoomParticipantsProfiles:async e=>await (0,t.safeSupabaseOperation)(async t=>{let{data:a,error:r}=await t.from("room_participants").select("profiles (*)").eq("room_id",e);return r?{data:[],error:r.message}:{data:a.map(e=>e.profiles),error:null}}),sendConnectionRequest:async e=>await (0,t.safeSupabaseOperation)(async t=>{let{data:{user:a}}=await t.auth.getUser();if(!a)return{error:"Not authenticated"};let{error:r}=await t.from("connections").insert({requester_id:a.id,addressee_id:e,status:"pending"});return{error:r?.message||null}}),getPendingRequests:async()=>await (0,t.safeSupabaseOperation)(async e=>{let{data:{user:t}}=await e.auth.getUser();if(!t)return{data:[],error:"Not authenticated"};let{data:a,error:r}=await e.from("connections").select(`
                    id,
                    requester_id,
                    created_at,
                    profiles:requester_id (
                        id,
                        username,
                        full_name,
                        avatar_url
                    )
                `).eq("addressee_id",t.id).eq("status","pending");return r?{data:[],error:r.message}:{data:a||[],error:null}}),getAcceptedConnections:async()=>await (0,t.safeSupabaseOperation)(async e=>{let{data:{user:t}}=await e.auth.getUser();if(!t)return{data:[],error:"Not authenticated"};let{data:a,error:r}=await e.from("connections").select(`
                    id,
                    requester_id,
                    addressee_id,
                    status,
                    created_at,
                    requester:requester_id (id, username, full_name, avatar_url, is_online, last_seen, gender, age),
                    addressee:addressee_id (id, username, full_name, avatar_url, is_online, last_seen, gender, age)
                `).or(`requester_id.eq.${t.id},addressee_id.eq.${t.id}`).eq("status","accepted");return r?{data:[],error:r.message}:{data:a.map(e=>{let a=e.requester_id===t.id?e.addressee:e.requester;return{connection_id:e.id,...a}}),error:null}}),async respondToConnection(e,a){return await (0,t.safeSupabaseOperation)(async t=>{let{error:r}=await t.from("connections").update({status:a}).eq("id",e);if(r)return{data:null,error:r.message};let s=null;if("accepted"===a){let{data:a}=await t.from("connections").select("requester_id, addressee_id").eq("id",e).single();if(a){let{data:e,error:t}=await this.createDirectChat(a.requester_id);if(t)return{data:null,error:t};s=e}}return{data:s,error:null}})},deleteRoom:async e=>await (0,t.safeSupabaseOperation)(async t=>{let{error:a}=await t.from("rooms").delete().eq("id",e);return{error:a?.message||null}}),updateMessageStatus:async(e,a)=>await (0,t.safeSupabaseOperation)(async t=>{let r={status:a};"delivered"===a&&(r.delivered_at=new Date().toISOString()),"read"===a&&(r.read_at=new Date().toISOString());let{error:s}=await t.from("messages").update(r).eq("id",e);return{error:s?.message||null}}),markRoomAsRead:async(e,a)=>await (0,t.safeSupabaseOperation)(async t=>{let{error:r}=await t.from("messages").update({status:"read",read_at:new Date().toISOString()}).eq("room_id",e).neq("user_id",a).neq("status","read");return{error:r?.message||null}}),blockUser:async e=>(console.log("[ChatService] Blocking user:",e),await (0,t.safeSupabaseOperation)(async t=>{let{data:{user:a}}=await t.auth.getUser();if(!a)return{error:"Not authenticated"};let{error:r}=await t.from("blocked_users").insert({blocker_id:a.id,blocked_id:e});return r?(console.error("[ChatService] blockUser error:",r),{error:r.message}):{error:null}})),unblockUser:async e=>await (0,t.safeSupabaseOperation)(async t=>{let{data:{user:a}}=await t.auth.getUser();if(!a)return{error:"Not authenticated"};let{error:r}=await t.from("blocked_users").delete().eq("blocker_id",a.id).eq("blocked_id",e);return{error:r?.message||null}}),async isBlocked(e){let{data:a}=await (0,t.safeSupabaseOperation)(async t=>{let{data:{user:a}}=await t.auth.getUser();return a?await t.from("blocked_users").select("id").or(`and(blocker_id.eq.${a.id},blocked_id.eq.${e}),and(blocker_id.eq.${e},blocked_id.eq.${a.id})`).maybeSingle():{data:null}});return!!a},getBlockedUsers:async()=>(console.log("[ChatService] Fetching blocked users..."),await (0,t.safeSupabaseOperation)(async e=>{let{data:{user:t}}=await e.auth.getUser();if(!t)return{data:[],error:"Not authenticated"};let{data:a,error:r}=await e.from("blocked_users").select(`
                    id,
                    blocked_id,
                    profiles:blocked_id (*)
                `).eq("blocker_id",t.id);if(r)return console.error("[ChatService] getBlockedUsers error:",r),{data:[],error:r.message};let s=(a||[]).map(e=>({id:e.blocked_id,username:e.profiles?.username||"Unknown",full_name:e.profiles?.full_name||"Unknown Gossiper",avatar_url:e.profiles?.avatar_url}));return console.log(`[ChatService] Found ${s.length} blocked users`),{data:s,error:null}}))}],58086)},65027,e=>{"use strict";var t=e.i(49982),a=e.i(72013),r=e.i(66635),s=e.i(23995),i=e.i(58086);let n=(0,a.createContext)(void 0);function o({children:e}){let{user:o}=(0,r.useAuth)(),[l,d]=(0,a.useState)([]),[c,u]=(0,a.useState)({}),[m,h]=(0,a.useState)([]),[f,p]=(0,a.useState)({}),[g,w]=(0,a.useState)(!1),_=(0,s.createClient)(),y=(0,a.useRef)(null),v=(0,a.useRef)(!1),b=(0,a.useRef)(!1);(0,a.useEffect)(()=>{if(o?.id){b.current||(w(!0),x().finally(()=>{w(!1),b.current=!0})),k(),i.ChatService.updateOnlineStatus(o.id,!0);let e=setInterval(()=>{I()},3e4);return()=>{clearInterval(e),i.ChatService.updateOnlineStatus(o.id,!1),S()}}d([]),u({}),h([]),p({}),w(!1),b.current=!1,S()},[o?.id]),(0,a.useEffect)(()=>{let e=localStorage.getItem("LOCKED_CHATS");e&&p(JSON.parse(e))},[]);let S=()=>{y.current&&(_.removeChannel(y.current),y.current=null)},x=async()=>{if(!v.current){v.current=!0;try{let[e,t,a]=await Promise.all([i.ChatService.getMyRooms(),i.ChatService.getPendingRequests(),i.ChatService.getAcceptedConnections()]);t.data&&h(t.data);let r=[],s=new Set;if(e.data){let t=e.data.map(e=>C(e));(await Promise.all(t)).forEach(e=>{e&&(r.push(e),"direct"===e.type&&s.add(e.userId))})}a.data&&a.data.forEach(e=>{s.has(e.id)||r.push({id:`temp_${e.id}`,userId:e.id,userName:e.username||e.full_name||"User",userAvatar:e.avatar_url||`https://i.pravatar.cc/150?u=${e.id}`,lastMessage:"Tap to start chatting",lastMessageTime:new Date(e.created_at||Date.now()),unreadCount:0,online:e.is_online||!1,typing:!1,type:"direct",age:e.age,gender:e.gender})}),d(e=>{let t=[...r].sort((e,t)=>t.lastMessageTime.getTime()-e.lastMessageTime.getTime());return JSON.stringify(e)===JSON.stringify(t)?e:t})}catch(e){console.error("[ChatContext] Load error:",e)}finally{v.current=!1}}},C=async e=>{let t=await i.ChatService.getRoomParticipants(e.id),{data:a}=await i.ChatService.getMessages(e.id,1,!1),r=a?.[0];if("direct"===e.type){let a=t.data?.find(e=>e.id!==o?.id);if(a){let{count:t}=await _.from("messages").select("*",{count:"exact",head:!0}).eq("room_id",e.id).neq("user_id",o?.id).neq("status","read");return{id:e.id,userId:a.id,userName:a.username||a.full_name||"User",userAvatar:a.avatar_url||`https://i.pravatar.cc/150?u=${a.id}`,lastMessage:r?.content||"Started a gossip...",lastMessageTime:new Date(r?r.created_at:e.created_at),unreadCount:t||0,online:a.is_online||!1,typing:!1,type:"direct",age:a.age,gender:a.gender}}}else{let{count:a}=await _.from("messages").select("*",{count:"exact",head:!0}).eq("room_id",e.id).neq("user_id",o?.id).neq("status","read"),s=t.data?.filter(e=>e.is_online).length||0,i=t.data?.length||0;return{id:e.id,userId:e.id,userName:e.name||"Gossip Group",userAvatar:e.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(e.name||"G")}&background=FFB6C1&color=000`,lastMessage:r?.content||"New gossip group created!",lastMessageTime:new Date(r?r.created_at:e.created_at),unreadCount:a||0,online:s>0,onlineCount:s,memberCount:i,description:e.description||"Welcome to the gossip group!",createdBy:e.created_by,typing:!1,type:"group"}}return null},k=()=>{S(),o?.id&&(y.current=_.channel("gossip-main",{config:{broadcast:{self:!1},presence:{key:o.id}}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},async e=>{let t=e.new;t.user_id!==o?.id&&"sent"===t.status&&i.ChatService.updateMessageStatus(t.id,"delivered");let a={id:t.id,chatId:t.room_id,senderId:t.user_id,content:t.content,type:t.message_type,timestamp:new Date(t.created_at),status:t.status,mediaUrl:t.media_url};u(e=>{let r=e[t.room_id]||[];return r.some(e=>e.id===a.id)?e:{...e,[t.room_id]:[...r,a]}}),I()}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages"},e=>{let t=e.new;u(e=>{let a=e[t.room_id]||[];return{...e,[t.room_id]:a.map(e=>e.id===t.id?{...e,status:t.status}:e)}})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"profiles"},e=>{let t=e.new;d(e=>e.map(e=>e.userId===t.id?{...e,online:t.is_online}:e))}).on("postgres_changes",{event:"*",schema:"public",table:"connections",filter:`addressee_id=eq.${o.id}`},async()=>{let{data:e}=await i.ChatService.getPendingRequests();e&&h(e)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"room_participants",filter:`user_id=eq.${o.id}`},()=>{I()}).on("broadcast",{event:"typing"},e=>{let{chatId:t,userId:a,isTyping:r}=e.payload;a!==o?.id&&d(e=>e.map(e=>e.id===t?{...e,typing:r}:e))}).subscribe())},j=async(e,t,a="text",r)=>{let{data:s,error:n}=await i.ChatService.sendMessage(e,t,a,r);if(n)throw Error(n);if(s){let t={id:s.id,chatId:s.room_id,senderId:s.user_id,content:s.content,type:s.message_type,timestamp:new Date(s.created_at),status:s.status,mediaUrl:s.media_url};u(a=>{let r=a[e]||[];return r.some(e=>e.id===t.id)?a:{...a,[e]:[...r,t]}})}},N=async e=>{o?.id&&(await i.ChatService.markRoomAsRead(e,o.id),d(t=>t.map(t=>t.id===e?{...t,unreadCount:0}:t)),u(t=>{let a=t[e];return a?{...t,[e]:a.map(e=>e.senderId!==o.id?{...e,status:"read"}:e)}:t}))},q=async(e,t)=>{y.current&&await y.current.send({type:"broadcast",event:"typing",payload:{chatId:e,userId:o?.id,isTyping:t}})},E=async(e,t,a)=>{let{data:r,error:s}=await i.ChatService.createDirectChat(e);if(s)throw Error(s);return await x(),r},T=async e=>{let{error:t}=await i.ChatService.sendConnectionRequest(e);if(t)throw Error(t)},R=async(e,t)=>{w(!0);let{data:a,error:r}=await i.ChatService.respondToConnection(e,t);return r?(w(!1),null):(h(t=>t.filter(t=>t.id!==e)),await x(),w(!1),a)},O=async e=>{let{data:t,error:a}=await i.ChatService.getMessages(e);if(!a&&t){let a=t.map(e=>({id:e.id,chatId:e.room_id,senderId:e.user_id,content:e.content,type:e.message_type,timestamp:new Date(e.created_at),status:e.status,mediaUrl:e.media_url}));u(t=>({...t,[e]:a}))}},I=async()=>{await x()},U=async e=>{let{error:t}=await i.ChatService.blockUser(e);if(t)throw Error(t);await I()},M=async e=>{let{error:t}=await i.ChatService.unblockUser(e);if(t)throw Error(t);await I()},A=async e=>{let{error:t}=await i.ChatService.deleteRoom(e);if(t)throw Error(t);await I()},$=async(e,t)=>{let{error:a}=await i.ChatService.updateRoom(e,t);if(a)throw Error(a);await I()},P=async e=>{let{data:t,error:a}=await i.ChatService.getRoomParticipantsProfiles(e);if(a)throw Error(a);return t||[]},D=async(e,t)=>{let a={...f,[e]:t};p(a),localStorage.setItem("LOCKED_CHATS",JSON.stringify(a))},z=async e=>{let t={...f};delete t[e],p(t),localStorage.setItem("LOCKED_CHATS",JSON.stringify(t))};return(0,t.jsx)(n.Provider,{value:{chats:l,messages:c,pendingRequests:m,loading:g,sendMessage:j,markAsRead:N,setTyping:q,createChat:E,sendRequest:T,respondToRequest:R,refreshChats:I,blockUser:U,unblockUser:M,deleteGroup:A,fetchMessages:O,updateGroup:$,getParticipants:P,lockedChats:f,lockChat:D,unlockChat:z},children:e})}function l(){let e=(0,a.useContext)(n);if(!e)throw Error("useChat must be used within ChatProvider");return e}e.s(["ChatProvider",()=>o,"useChat",()=>l])},68411,82646,e=>{"use strict";var t=e.i(7711);let a=(0,t.default)("mic",[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]]);e.s(["Mic",()=>a],68411);let r=(0,t.default)("mic-off",[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M16.95 16.95A7 7 0 0 1 5 12v-2",key:"cqa7eg"}],["path",{d:"M18.89 13.23A7 7 0 0 0 19 12v-2",key:"16hl24"}],["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}]]);e.s(["MicOff",()=>r],82646)},14709,e=>{"use strict";let t=(0,e.i(7711).default)("video",[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]]);e.s(["Video",()=>t],14709)},60564,e=>{"use strict";e.s(["CallProvider",()=>x,"useCall",()=>S],60564);var t=e.i(49982),a=e.i(72013),r=e.i(23995),s=e.i(77600),i=e.i(68411),n=e.i(82646),o=e.i(14709),l=e.i(7711);let d=(0,l.default)("video-off",[["path",{d:"M10.66 6H14a2 2 0 0 1 2 2v2.5l5.248-3.062A.5.5 0 0 1 22 7.87v8.196",key:"w8jjjt"}],["path",{d:"M16 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2",key:"1xawa7"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]),c=(0,l.default)("phone-off",[["path",{d:"M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272",key:"1wngk7"}],["path",{d:"M22 2 2 22",key:"y4kqgn"}],["path",{d:"M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473",key:"10hv5p"}]]),u=(0,l.default)("maximize-2",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]]),m=(0,l.default)("minimize-2",[["path",{d:"m14 10 7-7",key:"oa77jy"}],["path",{d:"M20 10h-6V4",key:"mjg0md"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M4 14h6v6",key:"rmj7iw"}]]);var h=e.i(36835),f=e.i(18409);function p(e){let r,l,p,y,v,b,x,C,k,j,N,q,E,T,R,O,I,U,M,A,$,P,D,z,L,B,V,H,G,F,W,J,K,Q,X,Y,Z,ee,et=(0,s.c)(101),{minimize:ea,onClose:er}=e,{localStream:es,remoteStream:ei,callType:en,connectionState:eo,signalingStatus:el,iceCandidateCount:ed}=S(),[ec,eu]=(0,a.useState)(void 0!==ea&&ea),[em,eh]=(0,a.useState)(!1),[ef,ep]=(0,a.useState)(!1),eg=(0,a.useRef)(null),ew=(0,a.useRef)(null);et[0]!==es?(r=()=>{eg.current&&es&&(eg.current.srcObject=es)},l=[es],et[0]=es,et[1]=r,et[2]=l):(r=et[1],l=et[2]),(0,a.useEffect)(r,l),et[3]!==ei?(p=()=>{ew.current&&ei&&(ew.current.srcObject=ei,ew.current.play().catch(_))},y=[ei],et[3]=ei,et[4]=p,et[5]=y):(p=et[4],y=et[5]),(0,a.useEffect)(p,y),et[6]!==ec?(v=()=>eu(!ec),et[6]=ec,et[7]=v):v=et[7];let e_=v;et[8]!==em||et[9]!==es?(b=()=>{es&&(es.getAudioTracks().forEach(w),eh(!em))},et[8]=em,et[9]=es,et[10]=b):b=et[10];let ey=b;et[11]!==ef||et[12]!==es?(x=()=>{es&&(es.getVideoTracks().forEach(g),ep(!ef))},et[11]=ef,et[12]=es,et[13]=x):x=et[13];let ev=x,eb="audio"===en,eS=ec?"bottom-4 right-4 w-72 h-48 rounded-2xl":"inset-4 rounded-3xl";et[14]!==eS?(C=(0,h.cn)("fixed transition-all duration-500 ease-in-out bg-black/90 backdrop-blur-md shadow-2xl border border-white/10 overflow-hidden z-50",eS),et[14]=eS,et[15]=C):C=et[15],et[16]!==el?(k=(0,t.jsxs)("div",{children:["Signal: ",el]}),et[16]=el,et[17]=k):k=et[17],et[18]!==eo?(j=(0,t.jsxs)("div",{children:["WebRTC: ",eo]}),et[18]=eo,et[19]=j):j=et[19],et[20]!==ed?(N=(0,t.jsxs)("div",{children:["Candidates: ",ed]}),et[20]=ed,et[21]=N):N=et[21],et[22]!==en?(q=(0,t.jsxs)("div",{children:["Type: ",en]}),et[22]=en,et[23]=q):q=et[23],et[24]!==es?(E=es?.getTracks().length||0,et[24]=es,et[25]=E):E=et[25],et[26]!==E?(T=(0,t.jsxs)("div",{children:["L-Tracks: ",E]}),et[26]=E,et[27]=T):T=et[27],et[28]!==ei?(R=ei?.getTracks().length||0,et[28]=ei,et[29]=R):R=et[29],et[30]!==R?(O=(0,t.jsxs)("div",{children:["R-Tracks: ",R]}),et[30]=R,et[31]=O):O=et[31],et[32]!==k||et[33]!==j||et[34]!==N||et[35]!==q||et[36]!==T||et[37]!==O?(I=(0,t.jsxs)("div",{className:"absolute top-4 left-4 z-50 bg-black/50 p-2 rounded text-xs text-white/70 font-mono pointer-events-none",children:[k,j,N,q,T,O]}),et[32]=k,et[33]=j,et[34]=N,et[35]=q,et[36]=T,et[37]=O,et[38]=I):I=et[38],et[39]!==eo||et[40]!==eb||et[41]!==ei?(U=(eb||!ei)&&(0,t.jsxs)("div",{className:"flex flex-col items-center animate-pulse",children:[(0,t.jsx)(f.Avatar,{fallback:"Remote",className:"w-32 h-32 bg-zinc-800 text-zinc-500 mb-6 text-4xl"}),(0,t.jsx)("p",{className:"text-zinc-400 text-lg font-medium",children:"connected"===eo?"Connected":"Connecting..."})]}),et[39]=eo,et[40]=eb,et[41]=ei,et[42]=U):U=et[42];let ex=(eb||!ei)&&"opacity-0 pointer-events-none";et[43]!==ex?(M=(0,h.cn)("absolute inset-0 w-full h-full object-cover",ex),et[43]=ex,et[44]=M):M=et[44],et[45]!==M?(A=(0,t.jsx)("video",{ref:ew,autoPlay:!0,playsInline:!0,className:M}),et[45]=M,et[46]=A):A=et[46],et[47]!==U||et[48]!==A?($=(0,t.jsxs)("div",{className:"w-full h-full bg-zinc-900 flex items-center justify-center relative",children:[U,A]}),et[47]=U,et[48]=A,et[49]=$):$=et[49],et[50]!==eb||et[51]!==ec||et[52]!==es?(P=!eb&&(0,t.jsx)("div",{className:(0,h.cn)("absolute transition-all duration-300 bg-zinc-800 rounded-xl overflow-hidden shadow-lg border border-white/10 z-10",ec?"hidden":"top-4 right-4 w-48 h-36"),children:(0,t.jsxs)("div",{className:"w-full h-full flex items-center justify-center relative bg-black",children:[!es&&(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"You"}),(0,t.jsx)("video",{ref:eg,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover transform -scale-x-100"})]})}),et[50]=eb,et[51]=ec,et[52]=es,et[53]=P):P=et[53];let eC=ec?"opacity-0 hover:opacity-100":"opacity-100";et[54]!==eC?(D=(0,h.cn)("absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent flex flex-col items-center justify-end transition-opacity z-20",eC),et[54]=eC,et[55]=D):D=et[55],et[56]!==eo||et[57]!==eb||et[58]!==ec?(z=!ec&&(0,t.jsxs)("div",{className:"mb-8 text-center",children:[(0,t.jsx)("h3",{className:"text-2xl font-bold text-white",children:eb?"Voice Call":"Video Call"}),(0,t.jsxs)("div",{className:"flex items-center justify-center gap-2",children:[(0,t.jsx)("span",{className:(0,h.cn)("w-2 h-2 rounded-full","connected"===eo?"bg-green-500":"bg-yellow-500")}),(0,t.jsx)("p",{className:"text-white/60 capitalize",children:eo})]})]}),et[56]=eo,et[57]=eb,et[58]=ec,et[59]=z):z=et[59];let ek=em?"bg-white text-black":"bg-white/10 text-white hover:bg-white/20";et[60]!==ek?(L=(0,h.cn)("p-4 rounded-full transition-all",ek),et[60]=ek,et[61]=L):L=et[61],et[62]!==em?(B=em?(0,t.jsx)(n.MicOff,{className:"w-6 h-6"}):(0,t.jsx)(i.Mic,{className:"w-6 h-6"}),et[62]=em,et[63]=B):B=et[63],et[64]!==L||et[65]!==B||et[66]!==ey?(V=(0,t.jsx)("button",{onClick:ey,className:L,children:B}),et[64]=L,et[65]=B,et[66]=ey,et[67]=V):V=et[67];let ej=ef?"bg-white text-black":"bg-white/10 text-white hover:bg-white/20";return et[68]!==ej?(H=(0,h.cn)("p-4 rounded-full transition-all",ej),et[68]=ej,et[69]=H):H=et[69],et[70]!==ef?(G=ef?(0,t.jsx)(d,{className:"w-6 h-6"}):(0,t.jsx)(o.Video,{className:"w-6 h-6"}),et[70]=ef,et[71]=G):G=et[71],et[72]!==H||et[73]!==G||et[74]!==ev?(F=(0,t.jsx)("button",{onClick:ev,className:H,children:G}),et[72]=H,et[73]=G,et[74]=ev,et[75]=F):F=et[75],et[76]===Symbol.for("react.memo_cache_sentinel")?(W=(0,t.jsx)(c,{className:"w-8 h-8"}),et[76]=W):W=et[76],et[77]!==er?(J=(0,t.jsx)("button",{onClick:er,className:"p-4 rounded-full bg-red-500 text-white hover:bg-red-600 transition-all shadow-lg hover:shadow-red-500/30 scale-100 hover:scale-110",children:W}),et[77]=er,et[78]=J):J=et[78],et[79]!==ec?(K=ec?(0,t.jsx)(u,{className:"w-6 h-6"}):(0,t.jsx)(m,{className:"w-6 h-6"}),et[79]=ec,et[80]=K):K=et[80],et[81]!==K||et[82]!==e_?(Q=(0,t.jsx)("button",{onClick:e_,className:"p-4 rounded-full bg-white/10 text-white hover:bg-white/20 transition-all",children:K}),et[81]=K,et[82]=e_,et[83]=Q):Q=et[83],et[84]!==V||et[85]!==F||et[86]!==J||et[87]!==Q?(X=(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[V,F,J,Q]}),et[84]=V,et[85]=F,et[86]=J,et[87]=Q,et[88]=X):X=et[88],et[89]!==D||et[90]!==z||et[91]!==X?(Y=(0,t.jsxs)("div",{className:D,children:[z,X]}),et[89]=D,et[90]=z,et[91]=X,et[92]=Y):Y=et[92],et[93]!==$||et[94]!==P||et[95]!==Y?(Z=(0,t.jsxs)("div",{className:"relative w-full h-full flex items-center justify-center",children:[$,P,Y]}),et[93]=$,et[94]=P,et[95]=Y,et[96]=Z):Z=et[96],et[97]!==C||et[98]!==I||et[99]!==Z?(ee=(0,t.jsxs)("div",{className:C,children:[I,Z]}),et[97]=C,et[98]=I,et[99]=Z,et[100]=ee):ee=et[100],ee}function g(e){return e.enabled=!e.enabled}function w(e){return e.enabled=!e.enabled}function _(e){return console.error("Error auto-playing video:",e)}let y={async initiateCall(e,t,a,s){try{return await (0,r.safeSupabaseOperation)(async r=>{let{data:{user:i}}=await r.auth.getUser();if(!i)throw Error("Not authenticated");let{data:n}=await r.from("blocked_users").select("id").or(`and(blocker_id.eq.${i.id},blocked_id.eq.${e}),and(blocker_id.eq.${e},blocked_id.eq.${i.id})`).maybeSingle();if(n)throw Error("User is blocked");let{data:o,error:l}=await r.from("calls").insert({caller_id:i.id,receiver_id:e||null,room_id:s||null,type:t,status:"ringing",offer_sdp:a}).select().single();return l?{data:null,error:l.message}:{data:o,error:null}})}catch(e){return{data:null,error:e.message}}},async updateCallStatus(e,t,a){try{return await (0,r.safeSupabaseOperation)(async r=>{let s={status:t};if(a&&(s.answer_sdp=a),("ended"===t||"rejected"===t||"missed"===t)&&(s.ended_at=new Date().toISOString(),"ended"===t)){let{data:t}=await r.from("calls").select("created_at").eq("id",e).single();if(t){let e=new Date(t.created_at).getTime(),a=new Date().getTime();s.duration=Math.floor((a-e)/1e3)}}let{error:i}=await r.from("calls").update(s).eq("id",e);return{error:i?.message||null}})}catch(e){return{error:e.message}}},async sendIceCandidate(e,t){try{return await (0,r.safeSupabaseOperation)(async a=>{let{data:{user:r}}=await a.auth.getUser();if(!r)return{error:"Not authenticated"};let{error:s}=await a.from("ice_candidates").insert({call_id:e,sender_id:r.id,candidate:t});return{error:s?.message||null}})}catch(e){return{error:e.message}}},async getIceCandidates(e){try{return await (0,r.safeSupabaseOperation)(async t=>{let{data:a,error:r}=await t.from("ice_candidates").select("*").eq("call_id",e).order("created_at",{ascending:!0});return{data:a||[],error:r?.message||null}})}catch(e){return{data:[],error:e.message}}},async getMessages(e,t=50,a=!1){try{return await (0,r.safeSupabaseOperation)(async r=>{let{data:s,error:i}=await r.from("messages").select(`
                        *,
                        profiles:user_id (
                            id, username, full_name, avatar_url, gender
                        )
                    `).eq("room_id",e).order("created_at",{ascending:a}).limit(t);return{data:s||[],error:i?.message||null}})}catch(e){return{data:[],error:e.message}}},async getCallHistory(){try{return await (0,r.safeSupabaseOperation)(async e=>{let{data:{user:t}}=await e.auth.getUser();if(!t)throw Error("Not authenticated");let{data:a,error:r}=await e.from("calls").select(`
                        *,
                        caller:caller_id (id, username, full_name, avatar_url, gender),
                        receiver:receiver_id (id, username, full_name, avatar_url, gender)
                    `).or(`caller_id.eq.${t.id},receiver_id.eq.${t.id}`).neq("status","ringing").order("created_at",{ascending:!1});return r?{data:[],error:r.message}:{data:a||[],error:null}})}catch(e){return{data:[],error:e.message}}}};var v=e.i(66635);let b=(0,a.createContext)(null);function S(){let e=(0,a.useContext)(b);if(!e)throw Error("useCall must be used within a CallProvider");return e}function x({children:e}){let{user:s}=(0,v.useAuth)(),[i,n]=(0,a.useState)(null),[o,l]=(0,a.useState)(null),[d,c]=(0,a.useState)(null),[u,m]=(0,a.useState)(null),[h,f]=(0,a.useState)("video"),[g,w]=(0,a.useState)("new"),[_,S]=(0,a.useState)("disconnected"),[x,C]=(0,a.useState)(0),[k,j]=(0,a.useState)([]),[N,q]=(0,a.useState)(!0),E=(0,a.useRef)(null),T=(0,r.createClient)(),R=(0,a.useRef)(null);(0,a.useRef)([]);let O={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478"}]};(0,a.useEffect)(()=>{if(!s)return;console.log("Listening for calls on user channel:",s.id);let e=T.channel(`calls:${s.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"calls",filter:`caller_id=neq.${s.id}`},async e=>{console.log("New call detected:",e),e.new.caller_id!==s.id&&"active"===e.new.status&&m(e.new)}).subscribe();return()=>{T.removeChannel(e)}},[s,T]),(0,a.useEffect)(()=>{let e=async()=>{q(!0);let{data:e}=await y.getCallHistory();e&&j(e),q(!1)};if(s){e();let t=T.channel("call_history_updates").on("postgres_changes",{event:"*",schema:"public",table:"calls"},()=>{e()}).subscribe();return()=>{T.removeChannel(t)}}},[s,T]),(0,a.useEffect)(()=>()=>{o?.getTracks().forEach(e=>e.stop()),E.current?.close()},[]);let I=(0,a.useRef)(null),U=(0,a.useRef)([]),M=async(e,t=!0)=>{try{C(0);let a=t?"video":"audio";if(f(a),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return void alert("Browser not supported (getUserMedia missing).");let r=await navigator.mediaDevices.getUserMedia({video:t,audio:!0});l(r);let i=new RTCPeerConnection(O);E.current=i,U.current=[],r.getTracks().forEach(e=>{i.addTrack(e,r)}),i.getTransceivers().forEach(e=>{"stopped"!==e.direction&&(e.direction="sendrecv")});let o=[];i.onicecandidate=async e=>{if(e.candidate)if(C(e=>e+1),I.current){let{error:t}=await T.from("ice_candidates").insert({call_id:I.current,candidate:e.candidate,sender_id:s?.id});t&&console.error("ICE Insert Error:",t)}else console.log("Queueing local candidate (Call ID not ready)"),o.push(e.candidate)},i.ontrack=e=>{console.log("Track received:",e.track.kind,e.streams[0]),c(new MediaStream(e.streams[0].getTracks()))},i.onconnectionstatechange=()=>{console.log("Connection state changes:",i.connectionState),w(i.connectionState)};let d=await i.createOffer();await i.setLocalDescription(d);let{data:u,error:m}=await T.from("calls").insert({room_id:e,caller_id:s?.id,status:"active",offer:d,type:a}).select().single();if(m)throw m;if(n(u),I.current=u.id,o.length>0){console.log(`Flushing ${o.length} queued local candidates`);let e=o.map(e=>({call_id:u.id,candidate:e,sender_id:s?.id})),{error:t}=await T.from("ice_candidates").insert(e);t&&console.error("Error flushing local candidates:",t)}D(u.id)}catch(e){console.error("Error starting call:",e),alert(`Call failed: ${e.message}`)}},A=async()=>{if(u)try{C(0);let e="video"===u.type;f(u.type||"video");let t=await navigator.mediaDevices.getUserMedia({video:e,audio:!0});l(t);let a=new RTCPeerConnection(O);E.current=a,I.current=u.id,U.current=[],a.onicecandidate=async e=>{if(e.candidate){C(e=>e+1);let{error:t}=await T.from("ice_candidates").insert({call_id:u.id,candidate:e.candidate,sender_id:s?.id});t&&console.error("ICE Insert Error:",t)}},a.ontrack=e=>{console.log("Track received:",e.track.kind,e.streams[0]),c(new MediaStream(e.streams[0].getTracks()))},a.onconnectionstatechange=()=>{console.log("Connection state changes:",a.connectionState),w(a.connectionState)},await a.setRemoteDescription(new RTCSessionDescription(u.offer)),t.getTracks().forEach(e=>{try{a.addTrack(e,t)}catch(e){console.error("Error adding track:",e)}}),a.getTransceivers().forEach(e=>{"stopped"!==e.direction&&(e.direction="sendrecv")});let r=await a.createAnswer();await a.setLocalDescription(r);let{error:i}=await T.from("calls").update({answer:r,status:"active"}).eq("id",u.id);if(i)throw i;n(u),m(null),D(u.id);let{data:o,error:d}=await T.from("ice_candidates").select("*").eq("call_id",u.id).neq("sender_id",s?.id||"");d&&console.error("Error fetching candidates:",d),o&&(console.log(`Found ${o.length} existing candidates`),o.forEach(async e=>{await a.addIceCandidate(new RTCIceCandidate(e.candidate))}))}catch(e){console.error("Error accepting call:",e),alert(`Accept call failed: ${e.message}`)}},$=async()=>{o?.getTracks().forEach(e=>e.stop()),E.current?.close(),i&&await T.from("calls").update({status:"ended"}).eq("id",i.id),l(null),c(null),n(null),m(null),w("new"),R.current&&(await T.removeChannel(R.current),R.current=null),I.current=null},P=async()=>{if(E.current&&U.current.length){for(let e of(console.log(`Processing ${U.current.length} queued remote candidates.`),U.current))try{await E.current.addIceCandidate(new RTCIceCandidate(e))}catch(e){console.error("Error flushing candidate from queue:",e)}U.current=[]}},D=e=>{R.current&&(T.removeChannel(R.current),R.current=null);let t=T.channel(`call_signaling:${e}`);S("initializing"),t.on("postgres_changes",{event:"INSERT",schema:"public",table:"ice_candidates",filter:`call_id=eq.${e}`},async e=>{if(e.new.sender_id!==s?.id&&E.current&&"closed"!==E.current.signalingState){console.log("Received new ICE candidate from DB via Realtime");let t=E.current,a=new RTCIceCandidate(e.new.candidate);if(t.remoteDescription&&"have-local-offer"!==t.signalingState)try{await t.addIceCandidate(a),console.log("Successfully added ICE candidate")}catch(t){console.error("Error adding live candidate:",t),(t.message?.includes("remote description")||"InvalidStateError"===t.name)&&(console.log("Add failed (remote desc missing/invalid state). Re-queueing candidate."),U.current.push(e.new.candidate))}else console.log("Remote description not set (or unstable). Queueing candidate."),U.current.push(e.new.candidate)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"calls",filter:`id=eq.${e}`},async e=>{if(e.new.answer&&!E.current?.currentRemoteDescription){console.log("Received Answer via Realtime");let t=e.new.answer;await E.current?.setRemoteDescription(new RTCSessionDescription(t)),await P()}"ended"===e.new.status&&$()}).subscribe(e=>{console.log("Signaling Channel Status:",e),S(e)}),R.current=t},z=async(e,t)=>{if(!s)return;let{data:a}=await T.from("room_participants").select("room_id").eq("user_id",s.id),r=null;if(a&&a.length>0){let t=a.map(e=>e.room_id),{data:s}=await T.from("room_participants").select("room_id").eq("user_id",e).in("room_id",t);if(s&&s.length>0){let{data:e}=await T.from("rooms").select("id").eq("is_group",!1).in("id",s.map(e=>e.room_id)).maybeSingle();e&&(r=e.id)}}if(!r){let{data:t}=await T.from("rooms").insert({is_group:!1,updated_at:new Date().toISOString()}).select().single();t&&(r=t.id,await T.from("room_participants").insert([{room_id:r,user_id:s.id},{room_id:r,user_id:e}]))}r&&await M(r,"video"===t)};return(0,t.jsxs)(b.Provider,{value:{isInCall:!!i,isIncomingCall:!!u,callDetails:i||u,startCall:M,acceptCall:A,endCall:$,localStream:o,remoteStream:d,callType:h,connectionState:g,signalingStatus:_,iceCandidateCount:x,callHistory:k,loading:N,initiateCall:z},children:[e,u&&!i&&(0,t.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm",children:(0,t.jsxs)("div",{className:"glass-card p-8 rounded-2xl flex flex-col items-center gap-4 animate-float",children:[(0,t.jsx)("div",{className:"w-20 h-20 rounded-full bg-primary/20 flex items-center justify-center animate-pulse",children:(0,t.jsx)("div",{className:"w-16 h-16 rounded-full bg-primary flex items-center justify-center text-white",children:"audio"===u.type?"ðŸŽ¤":"ðŸ“¹"})}),(0,t.jsxs)("h3",{className:"text-xl font-bold",children:["Incoming ","audio"===u.type?"Voice":"Video"," Call..."]}),(0,t.jsxs)("div",{className:"flex gap-4",children:[(0,t.jsx)("button",{onClick:A,className:"px-6 py-2 bg-green-500 rounded-full text-white font-medium hover:bg-green-600 transition-colors",children:"Accept"}),(0,t.jsx)("button",{onClick:()=>m(null),className:"px-6 py-2 bg-red-500 rounded-full text-white font-medium hover:bg-red-600 transition-colors",children:"Decline"})]})]})}),i&&(0,t.jsx)(p,{roomId:i.room_id,currentUser:s,onClose:$})]})}},49075,e=>{"use strict";var t=e.i(49982),a=e.i(77600),r=e.i(66635),s=e.i(65027),i=e.i(32758),n=e.i(60564),o=e.i(89934);function l(e){let l,d=(0,a.c)(2),{children:c}=e;return d[0]!==c?(l=(0,t.jsx)(r.AuthProvider,{children:(0,t.jsx)(o.ToastProvider,{children:(0,t.jsx)(i.StatusProvider,{children:(0,t.jsx)(s.ChatProvider,{children:(0,t.jsx)(n.CallProvider,{children:c})})})})}),d[0]=c,d[1]=l):l=d[1],l}e.s(["Providers",()=>l])}]);