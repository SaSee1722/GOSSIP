module.exports=[29476,64884,a=>{"use strict";var b=a.i(99881),c=a.i(57120),d=a.i(22536),e=a.i(42323);let f=async(a,b,c,d)=>(console.log("[NotificationService] Web Push Stub:",{token:a,title:b,body:c,data:d}),!0),g={async getMyRooms(){try{return await (0,e.safeSupabaseOperation)(async a=>{let{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Not authenticated");let{data:c,error:d}=await a.from("room_participants").select(`
            room_id,
            rooms (*)
          `).eq("user_id",b.id);if(d)return{data:[],error:d.message};if(!c||0===c.length)return{data:[],error:null};let{data:e}=await a.from("blocked_users").select("blocked_id").eq("blocker_id",b.id),f=(e||[]).map(a=>a.blocked_id),g=[];for(let d of c){let c=d.rooms;if(c){if("direct"===c.type){let{data:d}=await a.from("room_participants").select("user_id").eq("room_id",c.id).neq("user_id",b.id),e=d?.[0]?.user_id;if(e&&f.includes(e))continue}g.push(c)}}return{data:g,error:null}})}catch(a){return{data:[],error:a.message}}},async getRoomParticipants(a){try{return await (0,e.safeSupabaseOperation)(async b=>{let{data:c,error:d}=await b.from("room_participants").select(`
            user_id,
            profiles (
              id,
              username,
              full_name,
              avatar_url,
              is_online,
              last_seen,
              gender,
              age
            )
          `).eq("room_id",a);return d?{data:[],error:d.message}:{data:c.map(a=>a.profiles),error:null}})}catch(a){return{data:[],error:a.message}}},async getMessages(a,b=50,c=!0){try{return await (0,e.safeSupabaseOperation)(async d=>{let{data:e,error:f}=await d.from("messages").select("*").eq("room_id",a).order("created_at",{ascending:c}).limit(b);return f?{data:[],error:f.message}:{data:e||[],error:null}})}catch(a){return{data:[],error:a.message}}},async sendMessage(a,b,c="text",d){try{return await (0,e.safeSupabaseOperation)(async e=>{let{data:{user:g}}=await e.auth.getUser();if(!g)throw Error("Not authenticated");let{data:h}=await e.from("room_participants").select("user_id").eq("room_id",a).neq("user_id",g.id);if(h&&h.length>0){let a=h.map(a=>a.user_id),{data:b}=await e.from("blocked_users").select("id").or(`and(blocker_id.eq.${g.id},blocked_id.in.(${a.join(",")})),and(blocker_id.in.(${a.join(",")}),blocked_id.eq.${g.id})`).maybeSingle();if(b)throw Error("Cannot send message: Blocked connection")}let{data:i,error:j}=await e.from("messages").insert({room_id:a,user_id:g.id,content:b,message_type:c,media_url:d,status:"sent"}).select().single();return j?(console.error("[ChatService] sendMessage error:",j),{data:null,error:j.message}):((async()=>{try{let{data:d}=await e.from("room_participants").select("user_id, profiles(push_token, full_name, username)").eq("room_id",a).neq("user_id",g.id);if(d){let e=g.user_metadata?.username||"Gossiper",h=`New Gossip from ${e}`,i="text"===c?b:`Sent a ${c}`;for(let b of d){let c=b.profiles;c&&c.push_token&&f(c.push_token,h,i,{chatId:a,senderId:g.id})}}}catch(a){console.error("[ChatService] Failed to send push:",a)}})(),{data:i,error:null})})}catch(a){return{data:null,error:a.message}}},deleteMessage:async a=>await (0,e.safeSupabaseOperation)(async b=>{let{error:c}=await b.from("messages").update({is_deleted:!0,content:"deleted"}).eq("id",a);return{error:c?.message||null}}),async createDirectChat(a){try{return await (0,e.safeSupabaseOperation)(async b=>{let{data:{user:c}}=await b.auth.getUser();if(!c)throw Error("Not authenticated");let{data:d}=await b.rpc("get_direct_room",{user1:c.id,user2:a});if(d)return{data:d,error:null};let{data:e,error:f}=await b.from("rooms").insert({type:"direct",created_by:c.id}).select().single();if(f)return{data:null,error:f.message};let g=[{room_id:e.id,user_id:c.id,role:"owner"},{room_id:e.id,user_id:a,role:"member"}],{error:h}=await b.from("room_participants").insert(g);return h?{data:null,error:h.message}:{data:e.id,error:null}})}catch(a){return{data:null,error:a.message}}},async createGroupChat(a,b){try{return await (0,e.safeSupabaseOperation)(async c=>{let{data:{user:d}}=await c.auth.getUser();if(!d)throw Error("Not authenticated");let{data:e,error:f}=await c.from("rooms").insert({name:a,type:"group",created_by:d.id}).select().single();if(f)return{data:null,error:f.message};let g=[{room_id:e.id,user_id:d.id,role:"owner"},...b.map(a=>({room_id:e.id,user_id:a,role:"member"}))],{error:h}=await c.from("room_participants").insert(g);return h?{data:null,error:h.message}:{data:e.id,error:null}})}catch(a){return{data:null,error:a.message}}},updateRoom:async(a,b)=>await (0,e.safeSupabaseOperation)(async c=>{let{error:d}=await c.from("rooms").update(b).eq("id",a);return{error:d?.message||null}}),uploadGroupAvatar:async(a,b)=>await (0,e.safeSupabaseOperation)(async c=>{try{let d=b.name.split(".").pop()||"jpg",e=`group_${a}_${Date.now()}.${d}`,f=`groups/${e}`,{error:g}=await c.storage.from("gossip-avatars").upload(f,b,{contentType:b.type,upsert:!1});if(g)throw g;let{data:h}=c.storage.from("gossip-avatars").getPublicUrl(f);return{data:h.publicUrl,error:null}}catch(a){return{data:null,error:a.message}}}),uploadChatAttachment:async(a,b,c)=>await (0,e.safeSupabaseOperation)(async d=>{try{let e=b.name.split(".").pop()||"dat",f=`${"image"===c?"images":"video"===c?"videos":"docs"}/${a}_${Date.now()}.${e}`,{error:g}=await d.storage.from("chat-attachments").upload(f,b,{contentType:b.type,upsert:!1});if(g)throw g;let{data:h}=d.storage.from("chat-attachments").getPublicUrl(f);return{data:h.publicUrl,error:null}}catch(a){return{data:null,error:a.message}}}),updateOnlineStatus:async(a,b)=>await (0,e.safeSupabaseOperation)(async c=>{let{error:d}=await c.from("profiles").update({is_online:b,last_seen:new Date().toISOString()}).eq("id",a);return{error:d?.message||null}}),getRoomParticipantsProfiles:async a=>await (0,e.safeSupabaseOperation)(async b=>{let{data:c,error:d}=await b.from("room_participants").select("profiles (*)").eq("room_id",a);return d?{data:[],error:d.message}:{data:c.map(a=>a.profiles),error:null}}),sendConnectionRequest:async a=>await (0,e.safeSupabaseOperation)(async b=>{let{data:{user:c}}=await b.auth.getUser();if(!c)return{error:"Not authenticated"};let{error:d}=await b.from("connections").insert({requester_id:c.id,addressee_id:a,status:"pending"});return{error:d?.message||null}}),getPendingRequests:async()=>await (0,e.safeSupabaseOperation)(async a=>{let{data:{user:b}}=await a.auth.getUser();if(!b)return{data:[],error:"Not authenticated"};let{data:c,error:d}=await a.from("connections").select(`
                    id,
                    requester_id,
                    created_at,
                    profiles:requester_id (
                        id,
                        username,
                        full_name,
                        avatar_url
                    )
                `).eq("addressee_id",b.id).eq("status","pending");return d?{data:[],error:d.message}:{data:c||[],error:null}}),getAcceptedConnections:async()=>await (0,e.safeSupabaseOperation)(async a=>{let{data:{user:b}}=await a.auth.getUser();if(!b)return{data:[],error:"Not authenticated"};let{data:c,error:d}=await a.from("connections").select(`
                    id,
                    requester_id,
                    addressee_id,
                    status,
                    created_at,
                    requester:requester_id (id, username, full_name, avatar_url, is_online, last_seen, gender, age),
                    addressee:addressee_id (id, username, full_name, avatar_url, is_online, last_seen, gender, age)
                `).or(`requester_id.eq.${b.id},addressee_id.eq.${b.id}`).eq("status","accepted");return d?{data:[],error:d.message}:{data:c.map(a=>{let c=a.requester_id===b.id?a.addressee:a.requester;return{connection_id:a.id,...c}}),error:null}}),async respondToConnection(a,b){return await (0,e.safeSupabaseOperation)(async c=>{let{error:d}=await c.from("connections").update({status:b}).eq("id",a);if(d)return{data:null,error:d.message};let e=null;if("accepted"===b){let{data:b}=await c.from("connections").select("requester_id, addressee_id").eq("id",a).single();if(b){let{data:a,error:c}=await this.createDirectChat(b.requester_id);if(c)return{data:null,error:c};e=a}}return{data:e,error:null}})},deleteRoom:async a=>await (0,e.safeSupabaseOperation)(async b=>{let{error:c}=await b.from("rooms").delete().eq("id",a);return{error:c?.message||null}}),updateMessageStatus:async(a,b)=>await (0,e.safeSupabaseOperation)(async c=>{let d={status:b};"delivered"===b&&(d.delivered_at=new Date().toISOString()),"read"===b&&(d.read_at=new Date().toISOString());let{error:e}=await c.from("messages").update(d).eq("id",a);return{error:e?.message||null}}),markRoomAsRead:async(a,b)=>await (0,e.safeSupabaseOperation)(async c=>{let{error:d}=await c.from("messages").update({status:"read",read_at:new Date().toISOString()}).eq("room_id",a).neq("user_id",b).neq("status","read");return{error:d?.message||null}}),blockUser:async a=>(console.log("[ChatService] Blocking user:",a),await (0,e.safeSupabaseOperation)(async b=>{let{data:{user:c}}=await b.auth.getUser();if(!c)return{error:"Not authenticated"};let{error:d}=await b.from("blocked_users").insert({blocker_id:c.id,blocked_id:a});return d?(console.error("[ChatService] blockUser error:",d),{error:d.message}):{error:null}})),unblockUser:async a=>await (0,e.safeSupabaseOperation)(async b=>{let{data:{user:c}}=await b.auth.getUser();if(!c)return{error:"Not authenticated"};let{error:d}=await b.from("blocked_users").delete().eq("blocker_id",c.id).eq("blocked_id",a);return{error:d?.message||null}}),async isBlocked(a){let{data:b}=await (0,e.safeSupabaseOperation)(async b=>{let{data:{user:c}}=await b.auth.getUser();return c?await b.from("blocked_users").select("id").or(`and(blocker_id.eq.${c.id},blocked_id.eq.${a}),and(blocker_id.eq.${a},blocked_id.eq.${c.id})`).maybeSingle():{data:null}});return!!b},getBlockedUsers:async()=>(console.log("[ChatService] Fetching blocked users..."),await (0,e.safeSupabaseOperation)(async a=>{let{data:{user:b}}=await a.auth.getUser();if(!b)return{data:[],error:"Not authenticated"};let{data:c,error:d}=await a.from("blocked_users").select(`
                    id,
                    blocked_id,
                    profiles:blocked_id (*)
                `).eq("blocker_id",b.id);if(d)return console.error("[ChatService] getBlockedUsers error:",d),{data:[],error:d.message};let e=(c||[]).map(a=>({id:a.blocked_id,username:a.profiles?.username||"Unknown",full_name:a.profiles?.full_name||"Unknown Gossiper",avatar_url:a.profiles?.avatar_url}));return console.log(`[ChatService] Found ${e.length} blocked users`),{data:e,error:null}}))};a.s(["ChatService",0,g],64884);let h=(0,c.createContext)(void 0);function i({children:a}){let{user:f}=(0,d.useAuth)(),[i,j]=(0,c.useState)([]),[k,l]=(0,c.useState)({}),[m,n]=(0,c.useState)([]),[o,p]=(0,c.useState)({}),[q,r]=(0,c.useState)(!1),s=(0,e.createClient)(),t=(0,c.useRef)(null),u=(0,c.useRef)(!1),v=(0,c.useRef)(!1);(0,c.useEffect)(()=>{if(f?.id){v.current||(r(!0),x().finally(()=>{r(!1),v.current=!0})),z(),g.updateOnlineStatus(f.id,!0);let a=setInterval(()=>{H()},3e4);return()=>{clearInterval(a),g.updateOnlineStatus(f.id,!1),w()}}j([]),l({}),n([]),p({}),r(!1),v.current=!1,w()},[f?.id]),(0,c.useEffect)(()=>{let a=localStorage.getItem("LOCKED_CHATS");a&&p(JSON.parse(a))},[]);let w=()=>{t.current&&(s.removeChannel(t.current),t.current=null)},x=async()=>{if(!u.current){u.current=!0;try{let[a,b,c]=await Promise.all([g.getMyRooms(),g.getPendingRequests(),g.getAcceptedConnections()]);b.data&&n(b.data);let d=[],e=new Set;if(a.data){let b=a.data.map(a=>y(a));(await Promise.all(b)).forEach(a=>{a&&(d.push(a),"direct"===a.type&&e.add(a.userId))})}c.data&&c.data.forEach(a=>{e.has(a.id)||d.push({id:`temp_${a.id}`,userId:a.id,userName:a.username||a.full_name||"User",userAvatar:a.avatar_url||`https://i.pravatar.cc/150?u=${a.id}`,lastMessage:"Tap to start chatting",lastMessageTime:new Date(a.created_at||Date.now()),unreadCount:0,online:a.is_online||!1,typing:!1,type:"direct",age:a.age,gender:a.gender})}),j(a=>{let b=[...d].sort((a,b)=>b.lastMessageTime.getTime()-a.lastMessageTime.getTime());return JSON.stringify(a)===JSON.stringify(b)?a:b})}catch(a){console.error("[ChatContext] Load error:",a)}finally{u.current=!1}}},y=async a=>{let b=await g.getRoomParticipants(a.id),{data:c}=await g.getMessages(a.id,1,!1),d=c?.[0];if("direct"===a.type){let c=b.data?.find(a=>a.id!==f?.id);if(c){let{count:b}=await s.from("messages").select("*",{count:"exact",head:!0}).eq("room_id",a.id).neq("user_id",f?.id).neq("status","read");return{id:a.id,userId:c.id,userName:c.username||c.full_name||"User",userAvatar:c.avatar_url||`https://i.pravatar.cc/150?u=${c.id}`,lastMessage:d?.content||"Started a gossip...",lastMessageTime:new Date(d?d.created_at:a.created_at),unreadCount:b||0,online:c.is_online||!1,typing:!1,type:"direct",age:c.age,gender:c.gender}}}else{let{count:c}=await s.from("messages").select("*",{count:"exact",head:!0}).eq("room_id",a.id).neq("user_id",f?.id).neq("status","read"),e=b.data?.filter(a=>a.is_online).length||0,g=b.data?.length||0;return{id:a.id,userId:a.id,userName:a.name||"Gossip Group",userAvatar:a.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(a.name||"G")}&background=FFB6C1&color=000`,lastMessage:d?.content||"New gossip group created!",lastMessageTime:new Date(d?d.created_at:a.created_at),unreadCount:c||0,online:e>0,onlineCount:e,memberCount:g,description:a.description||"Welcome to the gossip group!",createdBy:a.created_by,typing:!1,type:"group"}}return null},z=()=>{w(),f?.id&&(t.current=s.channel("gossip-main",{config:{broadcast:{self:!1},presence:{key:f.id}}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},async a=>{let b=a.new;b.user_id!==f?.id&&"sent"===b.status&&g.updateMessageStatus(b.id,"delivered");let c={id:b.id,chatId:b.room_id,senderId:b.user_id,content:b.content,type:b.message_type,timestamp:new Date(b.created_at),status:b.status,mediaUrl:b.media_url};l(a=>{let d=a[b.room_id]||[];return d.some(a=>a.id===c.id)?a:{...a,[b.room_id]:[...d,c]}}),H()}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages"},a=>{let b=a.new;l(a=>{let c=a[b.room_id]||[];return{...a,[b.room_id]:c.map(a=>a.id===b.id?{...a,status:b.status}:a)}})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"profiles"},a=>{let b=a.new;j(a=>a.map(a=>a.userId===b.id?{...a,online:b.is_online}:a))}).on("postgres_changes",{event:"*",schema:"public",table:"connections",filter:`addressee_id=eq.${f.id}`},async()=>{let{data:a}=await g.getPendingRequests();a&&n(a)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"room_participants",filter:`user_id=eq.${f.id}`},()=>{H()}).on("broadcast",{event:"typing"},a=>{let{chatId:b,userId:c,isTyping:d}=a.payload;c!==f?.id&&j(a=>a.map(a=>a.id===b?{...a,typing:d}:a))}).subscribe())},A=async(a,b,c="text",d)=>{let{data:e,error:f}=await g.sendMessage(a,b,c,d);if(f)throw Error(f);if(e){let b={id:e.id,chatId:e.room_id,senderId:e.user_id,content:e.content,type:e.message_type,timestamp:new Date(e.created_at),status:e.status,mediaUrl:e.media_url};l(c=>{let d=c[a]||[];return d.some(a=>a.id===b.id)?c:{...c,[a]:[...d,b]}})}},B=async a=>{f?.id&&(await g.markRoomAsRead(a,f.id),j(b=>b.map(b=>b.id===a?{...b,unreadCount:0}:b)),l(b=>{let c=b[a];return c?{...b,[a]:c.map(a=>a.senderId!==f.id?{...a,status:"read"}:a)}:b}))},C=async(a,b)=>{t.current&&await t.current.send({type:"broadcast",event:"typing",payload:{chatId:a,userId:f?.id,isTyping:b}})},D=async(a,b,c)=>{let{data:d,error:e}=await g.createDirectChat(a);if(e)throw Error(e);return await x(),d},E=async a=>{let{error:b}=await g.sendConnectionRequest(a);if(b)throw Error(b)},F=async(a,b)=>{r(!0);let{data:c,error:d}=await g.respondToConnection(a,b);return d?(r(!1),null):(n(b=>b.filter(b=>b.id!==a)),await x(),r(!1),c)},G=async a=>{let{data:b,error:c}=await g.getMessages(a);if(!c&&b){let c=b.map(a=>({id:a.id,chatId:a.room_id,senderId:a.user_id,content:a.content,type:a.message_type,timestamp:new Date(a.created_at),status:a.status,mediaUrl:a.media_url}));l(b=>({...b,[a]:c}))}},H=async()=>{await x()},I=async a=>{let{error:b}=await g.blockUser(a);if(b)throw Error(b);await H()},J=async a=>{let{error:b}=await g.unblockUser(a);if(b)throw Error(b);await H()},K=async a=>{let{error:b}=await g.deleteRoom(a);if(b)throw Error(b);await H()},L=async(a,b)=>{let{error:c}=await g.updateRoom(a,b);if(c)throw Error(c);await H()},M=async a=>{let{data:b,error:c}=await g.getRoomParticipantsProfiles(a);if(c)throw Error(c);return b||[]},N=async(a,b)=>{let c={...o,[a]:b};p(c),localStorage.setItem("LOCKED_CHATS",JSON.stringify(c))},O=async a=>{let b={...o};delete b[a],p(b),localStorage.setItem("LOCKED_CHATS",JSON.stringify(b))};return(0,b.jsx)(h.Provider,{value:{chats:i,messages:k,pendingRequests:m,loading:q,sendMessage:A,markAsRead:B,setTyping:C,createChat:D,sendRequest:E,respondToRequest:F,refreshChats:H,blockUser:I,unblockUser:J,deleteGroup:K,fetchMessages:G,updateGroup:L,getParticipants:M,lockedChats:o,lockChat:N,unlockChat:O},children:a})}function j(){let a=(0,c.useContext)(h);if(!a)throw Error("useChat must be used within ChatProvider");return a}a.s(["ChatProvider",()=>i,"useChat",()=>j],29476)}];

//# sourceMappingURL=Desktop_GOSSIP_src_contexts_chat-context_tsx_0e0acf17._.js.map