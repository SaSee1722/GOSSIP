module.exports=[56381,39680,a=>{"use strict";var b=a.i(70981);let c=(0,b.default)("mic",[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]]);a.s(["Mic",()=>c],56381);let d=(0,b.default)("mic-off",[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M16.95 16.95A7 7 0 0 1 5 12v-2",key:"cqa7eg"}],["path",{d:"M18.89 13.23A7 7 0 0 0 19 12v-2",key:"16hl24"}],["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}]]);a.s(["MicOff",()=>d],39680)},24262,a=>{"use strict";let b=(0,a.i(70981).default)("video",[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]]);a.s(["Video",()=>b],24262)},65374,a=>{"use strict";a.s(["CallProvider",()=>t,"useCall",()=>s],65374);var b=a.i(99881),c=a.i(57120),d=a.i(42323),e=a.i(56381),f=a.i(39680),g=a.i(24262),h=a.i(70981);let i=(0,h.default)("video-off",[["path",{d:"M10.66 6H14a2 2 0 0 1 2 2v2.5l5.248-3.062A.5.5 0 0 1 22 7.87v8.196",key:"w8jjjt"}],["path",{d:"M16 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2",key:"1xawa7"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]),j=(0,h.default)("phone-off",[["path",{d:"M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272",key:"1wngk7"}],["path",{d:"M22 2 2 22",key:"y4kqgn"}],["path",{d:"M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473",key:"10hv5p"}]]),k=(0,h.default)("maximize-2",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]]),l=(0,h.default)("minimize-2",[["path",{d:"m14 10 7-7",key:"oa77jy"}],["path",{d:"M20 10h-6V4",key:"mjg0md"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M4 14h6v6",key:"rmj7iw"}]]);var m=a.i(83749),n=a.i(52053);function o({roomId:a,currentUser:d,minimize:h=!1,onClose:o}){let{localStream:p,remoteStream:q,callType:r,connectionState:t,signalingStatus:u,iceCandidateCount:v}=s(),[w,x]=(0,c.useState)(h),[y,z]=(0,c.useState)(!1),[A,B]=(0,c.useState)(!1),C=(0,c.useRef)(null),D=(0,c.useRef)(null);(0,c.useEffect)(()=>{C.current&&p&&(C.current.srcObject=p)},[p]),(0,c.useEffect)(()=>{D.current&&q&&(D.current.srcObject=q,D.current.play().catch(a=>console.error("Error auto-playing video:",a)))},[q]);let E="audio"===r;return(0,b.jsxs)("div",{className:(0,m.cn)("fixed transition-all duration-500 ease-in-out bg-black/90 backdrop-blur-md shadow-2xl border border-white/10 overflow-hidden z-50",w?"bottom-4 right-4 w-72 h-48 rounded-2xl":"inset-4 rounded-3xl"),children:[(0,b.jsxs)("div",{className:"absolute top-4 left-4 z-50 bg-black/50 p-2 rounded text-xs text-white/70 font-mono pointer-events-none",children:[(0,b.jsxs)("div",{children:["Signal: ",u]}),(0,b.jsxs)("div",{children:["WebRTC: ",t]}),(0,b.jsxs)("div",{children:["Candidates: ",v]}),(0,b.jsxs)("div",{children:["Type: ",r]}),(0,b.jsxs)("div",{children:["L-Tracks: ",p?.getTracks().length||0]}),(0,b.jsxs)("div",{children:["R-Tracks: ",q?.getTracks().length||0]})]}),(0,b.jsxs)("div",{className:"relative w-full h-full flex items-center justify-center",children:[(0,b.jsxs)("div",{className:"w-full h-full bg-zinc-900 flex items-center justify-center relative",children:[(E||!q)&&(0,b.jsxs)("div",{className:"flex flex-col items-center animate-pulse",children:[(0,b.jsx)(n.Avatar,{fallback:"Remote",className:"w-32 h-32 bg-zinc-800 text-zinc-500 mb-6 text-4xl"}),(0,b.jsx)("p",{className:"text-zinc-400 text-lg font-medium",children:"connected"===t?"Connected":"Connecting..."})]}),(0,b.jsx)("video",{ref:D,autoPlay:!0,playsInline:!0,className:(0,m.cn)("absolute inset-0 w-full h-full object-cover",(E||!q)&&"opacity-0 pointer-events-none")})]}),!E&&(0,b.jsx)("div",{className:(0,m.cn)("absolute transition-all duration-300 bg-zinc-800 rounded-xl overflow-hidden shadow-lg border border-white/10 z-10",w?"hidden":"top-4 right-4 w-48 h-36"),children:(0,b.jsxs)("div",{className:"w-full h-full flex items-center justify-center relative bg-black",children:[!p&&(0,b.jsx)("span",{className:"text-xs text-muted-foreground",children:"You"}),(0,b.jsx)("video",{ref:C,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover transform -scale-x-100"})]})}),(0,b.jsxs)("div",{className:(0,m.cn)("absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent flex flex-col items-center justify-end transition-opacity z-20",w?"opacity-0 hover:opacity-100":"opacity-100"),children:[!w&&(0,b.jsxs)("div",{className:"mb-8 text-center",children:[(0,b.jsx)("h3",{className:"text-2xl font-bold text-white",children:E?"Voice Call":"Video Call"}),(0,b.jsxs)("div",{className:"flex items-center justify-center gap-2",children:[(0,b.jsx)("span",{className:(0,m.cn)("w-2 h-2 rounded-full","connected"===t?"bg-green-500":"bg-yellow-500")}),(0,b.jsx)("p",{className:"text-white/60 capitalize",children:t})]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsx)("button",{onClick:()=>{p&&(p.getAudioTracks().forEach(a=>a.enabled=!a.enabled),z(!y))},className:(0,m.cn)("p-4 rounded-full transition-all",y?"bg-white text-black":"bg-white/10 text-white hover:bg-white/20"),children:y?(0,b.jsx)(f.MicOff,{className:"w-6 h-6"}):(0,b.jsx)(e.Mic,{className:"w-6 h-6"})}),(0,b.jsx)("button",{onClick:()=>{p&&(p.getVideoTracks().forEach(a=>a.enabled=!a.enabled),B(!A))},className:(0,m.cn)("p-4 rounded-full transition-all",A?"bg-white text-black":"bg-white/10 text-white hover:bg-white/20"),children:A?(0,b.jsx)(i,{className:"w-6 h-6"}):(0,b.jsx)(g.Video,{className:"w-6 h-6"})}),(0,b.jsx)("button",{onClick:o,className:"p-4 rounded-full bg-red-500 text-white hover:bg-red-600 transition-all shadow-lg hover:shadow-red-500/30 scale-100 hover:scale-110",children:(0,b.jsx)(j,{className:"w-8 h-8"})}),(0,b.jsx)("button",{onClick:()=>x(!w),className:"p-4 rounded-full bg-white/10 text-white hover:bg-white/20 transition-all",children:w?(0,b.jsx)(k,{className:"w-6 h-6"}):(0,b.jsx)(l,{className:"w-6 h-6"})})]})]})]})]})}let p={async initiateCall(a,b,c,e){try{return await (0,d.safeSupabaseOperation)(async d=>{let{data:{user:f}}=await d.auth.getUser();if(!f)throw Error("Not authenticated");let{data:g}=await d.from("blocked_users").select("id").or(`and(blocker_id.eq.${f.id},blocked_id.eq.${a}),and(blocker_id.eq.${a},blocked_id.eq.${f.id})`).maybeSingle();if(g)throw Error("User is blocked");let{data:h,error:i}=await d.from("calls").insert({caller_id:f.id,receiver_id:a||null,room_id:e||null,type:b,status:"ringing",offer_sdp:c}).select().single();return i?{data:null,error:i.message}:{data:h,error:null}})}catch(a){return{data:null,error:a.message}}},async updateCallStatus(a,b,c){try{return await (0,d.safeSupabaseOperation)(async d=>{let e={status:b};if(c&&(e.answer_sdp=c),("ended"===b||"rejected"===b||"missed"===b)&&(e.ended_at=new Date().toISOString(),"ended"===b)){let{data:b}=await d.from("calls").select("created_at").eq("id",a).single();if(b){let a=new Date(b.created_at).getTime(),c=new Date().getTime();e.duration=Math.floor((c-a)/1e3)}}let{error:f}=await d.from("calls").update(e).eq("id",a);return{error:f?.message||null}})}catch(a){return{error:a.message}}},async sendIceCandidate(a,b){try{return await (0,d.safeSupabaseOperation)(async c=>{let{data:{user:d}}=await c.auth.getUser();if(!d)return{error:"Not authenticated"};let{error:e}=await c.from("ice_candidates").insert({call_id:a,sender_id:d.id,candidate:b});return{error:e?.message||null}})}catch(a){return{error:a.message}}},async getIceCandidates(a){try{return await (0,d.safeSupabaseOperation)(async b=>{let{data:c,error:d}=await b.from("ice_candidates").select("*").eq("call_id",a).order("created_at",{ascending:!0});return{data:c||[],error:d?.message||null}})}catch(a){return{data:[],error:a.message}}},async getMessages(a,b=50,c=!1){try{return await (0,d.safeSupabaseOperation)(async d=>{let{data:e,error:f}=await d.from("messages").select(`
                        *,
                        profiles:user_id (
                            id, username, full_name, avatar_url, gender
                        )
                    `).eq("room_id",a).order("created_at",{ascending:c}).limit(b);return{data:e||[],error:f?.message||null}})}catch(a){return{data:[],error:a.message}}},async getCallHistory(){try{return await (0,d.safeSupabaseOperation)(async a=>{let{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Not authenticated");let{data:c,error:d}=await a.from("calls").select(`
                        *,
                        caller:caller_id (id, username, full_name, avatar_url, gender),
                        receiver:receiver_id (id, username, full_name, avatar_url, gender)
                    `).or(`caller_id.eq.${b.id},receiver_id.eq.${b.id}`).neq("status","ringing").order("created_at",{ascending:!1});return d?{data:[],error:d.message}:{data:c||[],error:null}})}catch(a){return{data:[],error:a.message}}}};var q=a.i(22536);let r=(0,c.createContext)(null);function s(){let a=(0,c.useContext)(r);if(!a)throw Error("useCall must be used within a CallProvider");return a}function t({children:a}){let{user:e}=(0,q.useAuth)(),[f,g]=(0,c.useState)(null),[h,i]=(0,c.useState)(null),[j,k]=(0,c.useState)(null),[l,m]=(0,c.useState)(null),[n,s]=(0,c.useState)("video"),[t,u]=(0,c.useState)("new"),[v,w]=(0,c.useState)("disconnected"),[x,y]=(0,c.useState)(0),[z,A]=(0,c.useState)([]),[B,C]=(0,c.useState)(!0),D=(0,c.useRef)(null),E=(0,d.createClient)(),F=(0,c.useRef)(null);(0,c.useRef)([]);let G={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478"}]};(0,c.useEffect)(()=>{if(!e)return;console.log("Listening for calls on user channel:",e.id);let a=E.channel(`calls:${e.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"calls",filter:`caller_id=neq.${e.id}`},async a=>{console.log("New call detected:",a),a.new.caller_id!==e.id&&"active"===a.new.status&&m(a.new)}).subscribe();return()=>{E.removeChannel(a)}},[e,E]),(0,c.useEffect)(()=>{let a=async()=>{C(!0);let{data:a}=await p.getCallHistory();a&&A(a),C(!1)};if(e){a();let b=E.channel("call_history_updates").on("postgres_changes",{event:"*",schema:"public",table:"calls"},()=>{a()}).subscribe();return()=>{E.removeChannel(b)}}},[e,E]),(0,c.useEffect)(()=>()=>{h?.getTracks().forEach(a=>a.stop()),D.current?.close()},[]);let H=(0,c.useRef)(null),I=(0,c.useRef)([]),J=async(a,b=!0)=>{try{y(0);let c=b?"video":"audio";if(s(c),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return void alert("Browser not supported (getUserMedia missing).");let d=await navigator.mediaDevices.getUserMedia({video:b,audio:!0});i(d);let f=new RTCPeerConnection(G);D.current=f,I.current=[],d.getTracks().forEach(a=>{f.addTrack(a,d)}),f.getTransceivers().forEach(a=>{"stopped"!==a.direction&&(a.direction="sendrecv")});let h=[];f.onicecandidate=async a=>{if(a.candidate)if(y(a=>a+1),H.current){let{error:b}=await E.from("ice_candidates").insert({call_id:H.current,candidate:a.candidate,sender_id:e?.id});b&&console.error("ICE Insert Error:",b)}else console.log("Queueing local candidate (Call ID not ready)"),h.push(a.candidate)},f.ontrack=a=>{console.log("Track received:",a.track.kind,a.streams[0]),k(new MediaStream(a.streams[0].getTracks()))},f.onconnectionstatechange=()=>{console.log("Connection state changes:",f.connectionState),u(f.connectionState)};let j=await f.createOffer();await f.setLocalDescription(j);let{data:l,error:m}=await E.from("calls").insert({room_id:a,caller_id:e?.id,status:"active",offer:j,type:c}).select().single();if(m)throw m;if(g(l),H.current=l.id,h.length>0){console.log(`Flushing ${h.length} queued local candidates`);let a=h.map(a=>({call_id:l.id,candidate:a,sender_id:e?.id})),{error:b}=await E.from("ice_candidates").insert(a);b&&console.error("Error flushing local candidates:",b)}N(l.id)}catch(a){console.error("Error starting call:",a),alert(`Call failed: ${a.message}`)}},K=async()=>{if(l)try{y(0);let a="video"===l.type;s(l.type||"video");let b=await navigator.mediaDevices.getUserMedia({video:a,audio:!0});i(b);let c=new RTCPeerConnection(G);D.current=c,H.current=l.id,I.current=[],c.onicecandidate=async a=>{if(a.candidate){y(a=>a+1);let{error:b}=await E.from("ice_candidates").insert({call_id:l.id,candidate:a.candidate,sender_id:e?.id});b&&console.error("ICE Insert Error:",b)}},c.ontrack=a=>{console.log("Track received:",a.track.kind,a.streams[0]),k(new MediaStream(a.streams[0].getTracks()))},c.onconnectionstatechange=()=>{console.log("Connection state changes:",c.connectionState),u(c.connectionState)},await c.setRemoteDescription(new RTCSessionDescription(l.offer)),b.getTracks().forEach(a=>{try{c.addTrack(a,b)}catch(a){console.error("Error adding track:",a)}}),c.getTransceivers().forEach(a=>{"stopped"!==a.direction&&(a.direction="sendrecv")});let d=await c.createAnswer();await c.setLocalDescription(d);let{error:f}=await E.from("calls").update({answer:d,status:"active"}).eq("id",l.id);if(f)throw f;g(l),m(null),N(l.id);let{data:h,error:j}=await E.from("ice_candidates").select("*").eq("call_id",l.id).neq("sender_id",e?.id||"");j&&console.error("Error fetching candidates:",j),h&&(console.log(`Found ${h.length} existing candidates`),h.forEach(async a=>{await c.addIceCandidate(new RTCIceCandidate(a.candidate))}))}catch(a){console.error("Error accepting call:",a),alert(`Accept call failed: ${a.message}`)}},L=async()=>{h?.getTracks().forEach(a=>a.stop()),D.current?.close(),f&&await E.from("calls").update({status:"ended"}).eq("id",f.id),i(null),k(null),g(null),m(null),u("new"),F.current&&(await E.removeChannel(F.current),F.current=null),H.current=null},M=async()=>{if(D.current&&I.current.length){for(let a of(console.log(`Processing ${I.current.length} queued remote candidates.`),I.current))try{await D.current.addIceCandidate(new RTCIceCandidate(a))}catch(a){console.error("Error flushing candidate from queue:",a)}I.current=[]}},N=a=>{F.current&&(E.removeChannel(F.current),F.current=null);let b=E.channel(`call_signaling:${a}`);w("initializing"),b.on("postgres_changes",{event:"INSERT",schema:"public",table:"ice_candidates",filter:`call_id=eq.${a}`},async a=>{if(a.new.sender_id!==e?.id&&D.current&&"closed"!==D.current.signalingState){console.log("Received new ICE candidate from DB via Realtime");let b=D.current,c=new RTCIceCandidate(a.new.candidate);if(b.remoteDescription&&"have-local-offer"!==b.signalingState)try{await b.addIceCandidate(c),console.log("Successfully added ICE candidate")}catch(b){console.error("Error adding live candidate:",b),(b.message?.includes("remote description")||"InvalidStateError"===b.name)&&(console.log("Add failed (remote desc missing/invalid state). Re-queueing candidate."),I.current.push(a.new.candidate))}else console.log("Remote description not set (or unstable). Queueing candidate."),I.current.push(a.new.candidate)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"calls",filter:`id=eq.${a}`},async a=>{if(a.new.answer&&!D.current?.currentRemoteDescription){console.log("Received Answer via Realtime");let b=a.new.answer;await D.current?.setRemoteDescription(new RTCSessionDescription(b)),await M()}"ended"===a.new.status&&L()}).subscribe(a=>{console.log("Signaling Channel Status:",a),w(a)}),F.current=b},O=async(a,b)=>{if(!e)return;let{data:c}=await E.from("room_participants").select("room_id").eq("user_id",e.id),d=null;if(c&&c.length>0){let b=c.map(a=>a.room_id),{data:e}=await E.from("room_participants").select("room_id").eq("user_id",a).in("room_id",b);if(e&&e.length>0){let{data:a}=await E.from("rooms").select("id").eq("is_group",!1).in("id",e.map(a=>a.room_id)).maybeSingle();a&&(d=a.id)}}if(!d){let{data:b}=await E.from("rooms").insert({is_group:!1,updated_at:new Date().toISOString()}).select().single();b&&(d=b.id,await E.from("room_participants").insert([{room_id:d,user_id:e.id},{room_id:d,user_id:a}]))}d&&await J(d,"video"===b)};return(0,b.jsxs)(r.Provider,{value:{isInCall:!!f,isIncomingCall:!!l,callDetails:f||l,startCall:J,acceptCall:K,endCall:L,localStream:h,remoteStream:j,callType:n,connectionState:t,signalingStatus:v,iceCandidateCount:x,callHistory:z,loading:B,initiateCall:O},children:[a,l&&!f&&(0,b.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm",children:(0,b.jsxs)("div",{className:"glass-card p-8 rounded-2xl flex flex-col items-center gap-4 animate-float",children:[(0,b.jsx)("div",{className:"w-20 h-20 rounded-full bg-primary/20 flex items-center justify-center animate-pulse",children:(0,b.jsx)("div",{className:"w-16 h-16 rounded-full bg-primary flex items-center justify-center text-white",children:"audio"===l.type?"ðŸŽ¤":"ðŸ“¹"})}),(0,b.jsxs)("h3",{className:"text-xl font-bold",children:["Incoming ","audio"===l.type?"Voice":"Video"," Call..."]}),(0,b.jsxs)("div",{className:"flex gap-4",children:[(0,b.jsx)("button",{onClick:K,className:"px-6 py-2 bg-green-500 rounded-full text-white font-medium hover:bg-green-600 transition-colors",children:"Accept"}),(0,b.jsx)("button",{onClick:()=>m(null),className:"px-6 py-2 bg-red-500 rounded-full text-white font-medium hover:bg-red-600 transition-colors",children:"Decline"})]})]})}),f&&(0,b.jsx)(o,{roomId:f.room_id,currentUser:e,onClose:L})]})}}];

//# sourceMappingURL=Desktop_GOSSIP_de502c09._.js.map